generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum SubscriptionTier {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

model User {
  id                     String           @id @default(cuid())
  name                   String?
  email                  String           @unique
  emailVerified          DateTime?
  image                  String?
  hashedPassword         String?
  purchasedBalance       Int              @default(100)
  earnedBalance          Int              @default(0)
  subscription           SubscriptionTier @default(FREE)
  stripeCustomerId       String?
  stripeConnectId        String?
  stripeConnectOnboarded Boolean          @default(false)
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt

  accounts   Account[]
  sessions   Session[]
  workflows  Workflow[]
  executions Execution[]
  payouts    Payout[]
}

enum IOType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
}

enum WorkflowCategory {
  CONTENT
  MARKETING
  DEVELOPMENT
  DESIGN
  AUDIO_VIDEO
  DATA
  EDUCATION
  OTHER
}

model Workflow {
  id             String           @id @default(cuid())
  creatorId      String
  name           String
  description    String           @db.Text
  category       WorkflowCategory @default(OTHER)
  priceInNolinks Int              @default(0)
  isPublic       Boolean          @default(true)
  totalUses      Int              @default(0)
  totalEarnings  Int              @default(0)
  slug           String           @unique
  thumbnail      String?
  tags           String[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  creator    User               @relation(fields: [creatorId], references: [id])
  steps      Step[]
  executions Execution[]
  analytics  WorkflowAnalytics[]
}

enum StepType {
  INPUT
  OUTPUT
  BASIC
  FAL_AI
}

model Step {
  id         String   @id @default(cuid())
  workflowId String
  order      Int
  name       String
  stepType   StepType @default(BASIC)
  aiModel    String?
  inputType  IOType
  outputType IOType
  prompt     String   @db.Text
  config     Json?
  params     Json?
  acceptTypes String[]
  positionX  Float    @default(0)
  positionY  Float    @default(0)

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, order])
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model Execution {
  id           String          @id @default(cuid())
  workflowId   String
  userId       String
  status       ExecutionStatus @default(PENDING)
  inputs       Json
  outputs      Json?
  stepResults  Json?
  creditsUsed  Int             @default(0)
  errorMessage String?
  startedAt    DateTime        @default(now())
  completedAt  DateTime?

  workflow Workflow @relation(fields: [workflowId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
}

model CreditTransaction {
  id        String   @id @default(cuid())
  userId    String
  amount    Int
  type      String
  wallet    String   @default("purchased")
  reason    String
  createdAt DateTime @default(now())
}

enum PayoutStatus {
  PENDING
  COMPLETED
  FAILED
}

model Payout {
  id               String       @id @default(cuid())
  userId           String
  amountNL         Int
  amountCents      Int
  stripeTransferId String?
  status           PayoutStatus @default(PENDING)
  failureReason    String?
  createdAt        DateTime     @default(now())
  completedAt      DateTime?

  user User @relation(fields: [userId], references: [id])
}

model WorkflowAnalytics {
  id          String   @id @default(cuid())
  workflowId  String
  date        DateTime @db.Date
  runs        Int      @default(0)
  revenueNL   Int      @default(0)
  uniqueUsers Int      @default(0)

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, date])
}
